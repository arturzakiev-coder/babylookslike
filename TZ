# **Единое ТЗ мобильного приложения "На кого похож малыш?"**

## **1. Общая информация**

### **1.1. Наименование проекта**
Мобильное приложение для сравнения внешности ребенка с родителями с использованием технологий распознавания лиц.

### **1.2. Целевые платформы**
- iOS 13.0+
- Android 8.0+ (API 26+)

### **1.3. Технологический стек**
- **Flutter 3.x + Dart**
- **Firebase Cloud Firestore** - только хранение баланса попыток
- **RevenueCat** - управление покупками (кроссплатформенное)
- **Face Recognition API** - сторонний API для сравнения лиц

---

## **2. Функциональные требования**

### **2.1. Основной функционал**

#### **2.1.1. Загрузка фотографий**
- Загрузка 3 фотографий: ребенок, мама, папа
- Источники:
  - Камера устройства
  - Галерея устройства
- Требования к фото:
  - Минимальное разрешение: 500x500px
  - Форматы: JPG, PNG
  - Максимальный размер: 10MB
  - Лицо должно занимать ≥30% кадра

#### **2.1.2. Сравнение лиц**
- **Режим "Малыш-родители"**: сравнение ребенка с обоими родителями
- **Произвольный режим**: сравнение любых двух лиц
- Результаты:
  - Общий процент схожести
  - Детализация по чертам (глаза, нос, губы, форма лица)

#### **2.1.3. Показ результатов**
- Визуализация процента схожести
- Возможность поделиться результатом
- Сохранение в историю (опционально)

---

## **3. Система монетизации**

### **3.1. Модель использования**
- **Бесплатные попытки**: 3 при первом запуске
- **Лимит**: после исчерпания требуется покупка

### **3.2. Пакеты попыток**
- **Мини**: 10 попыток - 99₽
- **Стандарт**: 30 попыток - 249₽
- **Премиум**: 100 попыток - 699₽

### **3.3. Подписка** (опционально)
- **Месячная**: 299₽/мес
- **Годовая**: 1990₽/год

### **3.4. Техническая реализация**
- **RevenueCat** для кроссплатформенных покупок
- Валидация и восстановление покупок
- Локальное кэширование статуса покупок

---

## **4. Управление балансом попыток**

### **4.1. Облачная схема**
```dart
// Firestore коллекция: balances
{
  deviceId: string,        // Уникальный ID устройства
  freeAttempts: number,    // Бесплатные попытки (старт: 3)
  purchasedAttempts: number, // Купленные попытки
  lastUpdated: timestamp,  // Время последнего обновления
  created: timestamp       // Время создания записи
}
```

### **4.2. Алгоритм работы**
1. **Первый запуск**: Генерация deviceId → создание записи с 3 попытками
2. **Проверка баланса**: Онлайн-запрос к Firestore
3. **Списание**: purchasedAttempts → freeAttempts
4. **Пополнение**: При покупке → добавление в purchasedAttempts

### **4.3. Простой сервис**
```dart
class BalanceService {
  Future<Map<String, int>> getBalance(String deviceId) {...}
  Future<void> useOneAttempt(String deviceId) {...}
  Future<void> addAttempts(String deviceId, int amount) {...}
}
```

---

## **5. Упрощенная облачная инфраструктура**

### **5.1. Используется только**
- **Firebase Cloud Firestore** - коллекция `balances`
- **RevenueCat** - покупки и подписки

### **5.2. НЕ используется**
- Firebase Authentication
- Firebase Storage
- Firebase Remote Config
- Firebase Analytics (опционально)
- Офлайн-режим
- Синхронизация между устройствами

### **5.3. Правила Firestore** (разработка)
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}
```

---

## **6. Архитектура приложения**

### **6.1. Структура проекта**
```
lib/
├── models/
│   ├── balance_model.dart
│   └── comparison_model.dart
├── services/
│   ├── firestore_service.dart      # Только баланс
│   ├── revenuecat_service.dart     # Покупки через RevenueCat
│   ├── face_api_service.dart       # Face Recognition API
│   ├── photo_service.dart          # Работа с камерой/галереей
│   └── device_id_service.dart      # Генерация deviceId
├── screens/
│   ├── main_screen.dart            # Главный экран
│   ├── photo_upload_screen.dart    # Загрузка фото (3 фото)
│   ├── processing_screen.dart      # Экран обработки
│   ├── result_screen.dart          # Результаты сравнения
│   ├── purchase_screen.dart        # Покупка попыток
│   └── balance_info_screen.dart    # Информация о балансе
├── widgets/
│   ├── attempt_counter.dart        # Виджет счета попыток
│   └── photo_picker.dart           // Виджет выбора фото
├── utils/
│   ├── constants.dart
│   └── helpers.dart
└── main.dart
```

### **6.2. Зависимости** (pubspec.yaml)
```yaml
dependencies:
  flutter:
    sdk: flutter
  
  # Firebase (только Firestore)
  firebase_core: ^2.24.0
  cloud_firestore: ^4.13.0
  
  # RevenueCat для покупок
  revenue_cat_flutter: ^4.16.0
  
  # Работа с фото
  image_picker: ^1.0.4
  image: ^4.1.4       # Для обработки изображений
  
  # Утилиты
  uuid: ^4.3.0        # Генерация deviceId
  connectivity_plus: ^5.0.1  # Проверка интернета
  provider: ^6.1.1    # Управление состоянием
  
  # UI
  lottie: ^2.7.0      # Анимации
  share_plus: ^7.2.1  # Поделиться результатом
```

---

## **7. Основные экраны и навигация**

### **7.1. Навигационный граф**
```
1. Splash Screen
   ↓
2. Main Screen (главный экран)
   ├──→ Photo Upload Screen (загрузка 3 фото)
   │       ↓
   │    Processing Screen (обработка)
   │       ↓
   │    Result Screen (результаты)
   │
   ├──→ Purchase Screen (покупка попыток)
   │
   └──→ Balance Info Screen (информация о балансе)
```

### **7.2. Главный экран (Main Screen)**
- Отображение текущего баланса попыток
- Кнопка "Сравнить" (проверяет баланс)
- Кнопка "Купить попытки"
- Информация о приложении

### **7.3. Экран загрузки фото (Photo Upload Screen)**
- Заголовок: "Загрузите 3 фото"
- 3 области для фото: "Малыш", "Мама", "Папа"
- Для каждой области:
  - Кнопка "Камера"
  - Кнопка "Галерея"
  - Превью загруженного фото
- Кнопка "Продолжить" (только когда все 3 фото загружены)

---

## **8. Работа с Face Recognition API**

### **8.1. Процесс сравнения**
```dart
Future<ComparisonResult> compareFaces(List<String> imagePaths) async {
  // 1. Подготовка изображений (сжатие, конвертация)
  // 2. Отправка в Face Recognition API
  // 3. Обработка ответа
  // 4. Форматирование результата
}
```

### **8.2. Формат запроса/ответа** (пример)
```json
// Запрос к API
{
  "images": [
    "base64_encoded_image_1",
    "base64_encoded_image_2",
    "base64_encoded_image_3"
  ],
  "mode": "baby_parents"
}

// Ответ API
{
  "success": true,
  "results": {
    "overall_similarity": 75.5,
    "details": {
      "eyes": 80.0,
      "nose": 70.0,
      "mouth": 65.0,
      "face_shape": 85.0
    },
    "comparisons": [
      {"pair": ["baby", "mother"], "similarity": 78.0},
      {"pair": ["baby", "father"], "similarity": 73.0}
    ]
  }
}
```

---

## **9. Технические требования**

### **9.1. Производительность**
- Время обработки сравнения: ≤10 секунд
- Загрузка приложения: ≤3 секунд
- Плавность интерфейса: 60 FPS

### **9.2. Безопасность**
- Face Recognition API ключ защищен
- Покупки через официальные магазины
- Локальное хранение только кэша

### **9.3. Обработка ошибок**
- Нет интернета → сообщение с просьбой подключиться
- Ошибка API → повторная попытка (1 раз)
- Недостаточно попыток → переход на экран покупки

---

## **10. Процесс разработки**

### **Этап 1: Базовая настройка** (2-3 дня)
1. Настройка Flutter проекта
2. Интеграция Firebase (только Firestore)
3. Настройка RevenueCat
4. Базовая структура экранов

### **Этап 2: Основной функционал** (5-7 дней)
1. Работа с камерой/галереей
2. Экран загрузки 3 фото
3. Интеграция Face Recognition API
4. Экран результатов

### **Этап 3: Монетизация** (3-4 дня)
1. Система баланса в Firestore
2. Экран покупок через RevenueCat
3. Списание/пополнение попыток

### **Этап 4: Полировка** (2-3 дня)
1. UI/UX улучшения
2. Обработка ошибок
3. Тестирование
4. Подготовка к публикации

---

## **11. Конфигурация для разработки**

### **11.1. Firebase настройка**
1. Создать проект в Firebase Console
2. Добавить приложения iOS (Bundle ID) и Android (Package Name)
3. Скачать конфигурационные файлы
4. Настроить Firestore с тестовыми правилами

### **11.2. RevenueCat настройка**
1. Создать проект в RevenueCat
2. Настроить продукты в App Store Connect и Google Play Console
3. Создать пакеты попыток в RevenueCat
4. Получить API ключ

### **11.3. Face Recognition API**
1. Получить API ключ и эндпоинт
2. Настроить в коде приложения

---

## **12. Требования к публикации**

### **12.1. Для App Store**
- Иконка приложения (1024x1024)
- Скриншоты для iPhone (5.5", 6.5")
- Описание на русском языке
- Политика конфиденциальности
- Возрастной рейтинг: 4+

### **12.2. Для Google Play**
- Иконка (512x512)
- Скриншоты для разных плотностей пикселей
- Описание
- Политика конфиденциальности
- Контент-рейтинг: Для всех

---

## **13. Дальнейшее развитие** (фаза 2)

### **Потенциальные улучшения:**
1. История сравнений в Firestore
2. Сохранение фото (с согласия пользователя)
3. Социальные функции (публикация результатов)
4. Расширенные алгоритмы сравнения
5. Аналитика использования

---

## **14. Ключевые ограничения и упрощения**

### **Упрощения в MVP:**
1. Нет авторизации пользователей
2. Нет офлайн-режима
3. Нет синхронизации между устройствами
4. Нет сложной аналитики
5. Нет админ-панели

### **Преимущества подхода:**
1. Быстрая разработка (2-3 недели)
2. Низкая сложность
3. Минимальные затраты на инфраструктуру
4. Легкое тестирование
5. Простое масштабирование при успехе

---

